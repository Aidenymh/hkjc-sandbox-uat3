name: 'Terraform'

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'nonprod'
        type: choice
        options:
          - nonprod
          - prod
      tfc_organization:
        description: 'Terraform Cloud ç»„ç»‡åç§°'
        required: true
        default: 'HKJC-TFC-Nonprod1'
        type: string
      tfc_workspace:
        description: 'Terraform Cloud å·¥ä½œç©ºé—´åç§°'
        required: true
        default: 'tencent-core-network-nonprod'
        type: string
      confirm_apply:
        description: 'ç¡®è®¤è¦æ‰§è¡Œ Terraform Apply å—ï¼Ÿ'
        required: true
        default: 'false'
        type: boolean

# ä» GitHub Secrets è¯»å–ç¯å¢ƒå˜é‡
env:
  TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
  ENV: ${{ secrets.ENV }}
  TFC_ORG: ${{ secrets.TFC_ORG }}
  WORKSPACE: ${{ secrets.WORKSPACE }}

permissions:
  contents: write
  actions: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  terraform-plan:
    name: "Terraform Plan - ${{ github.event.inputs.environment || 'nonprod' }}"
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        cli_config_credentials_token: ${{ secrets.TFC_TOKEN }}

    - name: Terraform Init
      env:
        TF_LOG: DEBUG
      run: |
        echo "Initializing Terraform with HCP Terraform..."
        terraform version
        terraform init -no-color
      working-directory: lz-core

    - name: Terraform Format
      run: terraform fmt -check
      working-directory: lz-core

    - name: Check Env Variables
      run: |
        echo "=== ç¯å¢ƒå˜é‡æ£€æŸ¥ ==="
        echo "TFC_TOKEN: ${#TFC_TOKEN} characters"
        echo "ENV: $ENV"
        echo "TFC_ORG: $TFC_ORG"
        echo "WORKSPACE: $WORKSPACE"
        echo "Environment: ${{ github.event.inputs.environment || 'nonprod' }}"
        echo "TFC Organization: ${{ github.event.inputs.tfc_organization || 'HKJC-TFC-Nonprod1' }}"
        echo "TFC Workspace: ${{ github.event.inputs.tfc_workspace || 'tencent-core-network-nonprod' }}"

    - name: Terraform Plan
      id: plan
      env:
        TF_VAR_environment: ${{ github.event.inputs.environment || 'nonprod' }}
        TF_VAR_tfc_organization: $TFC_ORG
        TF_VAR_tfc_workspace: $WORKSPACE
      run: |
        echo "Environment: $TF_VAR_environment"
        echo "TFC Organization: $TF_VAR_tfc_organization"
        echo "TFC Workspace: $TF_VAR_tfc_workspace"
        terraform plan -out=tfplan -input=false
      working-directory: lz-core

    # ä¸Šä¼  plan æ–‡ä»¶ä»¥ä¾› apply job ä½¿ç”¨
    - name: Upload Terraform Plan
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-${{ github.event.inputs.environment || 'nonprod' }}
        path: lz-core/tfplan

    # æç¤ºéœ€è¦æ‰‹åŠ¨æ‰§è¡Œ Apply (ä»…åœ¨æ¨é€ä»£ç æ—¶æ˜¾ç¤º)
    - name: Manual Apply Required
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "âœ… Terraform Plan å®Œæˆ"
        echo "ğŸ“‹ ç¯å¢ƒ: ${{ github.event.inputs.environment || 'nonprod' }}"
        echo "ğŸ“‹ è¯·æŸ¥çœ‹ä¸Šé¢çš„ Plan ç»“æœ"
        echo "ğŸš€ å¦‚éœ€æ‰§è¡Œ Applyï¼Œè¯·å®¡æ‰¹issue"

  # æ‰‹åŠ¨å®¡æ‰¹ job - åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  manual-approval:
    name: "ç­‰å¾…äººå·¥å®¡æ‰¹ - ${{ github.event.inputs.environment || 'nonprod' }}"
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ç­‰å¾…äººå·¥å®¡æ‰¹
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.token }}
        approvers: "Aidenymh"
        minimum-approvals: 1
        issue-title: "Terraform Apply å®¡æ‰¹è¯·æ±‚ - ${{ github.event.inputs.environment || 'nonprod' }}"
        issue-body: |
          ## Terraform Apply å®¡æ‰¹è¯·æ±‚
          
          **ç¯å¢ƒ**: ${{ github.event.inputs.environment || 'nonprod' }}
          **TFC ç»„ç»‡**: $TFC_ORG
          **TFC å·¥ä½œç©ºé—´**: $WORKSPACE
          **å·¥ä½œæµè¿è¡Œ**: ${{ github.run_id }}
          **åˆ†æ”¯**: ${{ github.ref }}
          **æäº¤**: ${{ github.sha }}
          **æäº¤è€…**: ${{ github.actor }}
          
          è¯·æŸ¥çœ‹ Terraform Plan ç»“æœï¼Œç¡®è®¤åæ‰¹å‡†æ­¤æ¬¡éƒ¨ç½²ã€‚
          
          [æŸ¥çœ‹å·¥ä½œæµè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          å›å¤ "approved", "approve", "lgtm", "yes" æ¥æ‰¹å‡†ç»§ç»­ï¼Œæˆ– "denied", "deny", "no" æ¥å–æ¶ˆã€‚

  terraform-apply:
    name: "Terraform Apply (å·²å®¡æ‰¹) - ${{ github.event.inputs.environment || 'nonprod' }}"
    runs-on: ubuntu-latest
    needs: [terraform-plan, manual-approval]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        cli_config_credentials_token: ${{ secrets.TFC_TOKEN }}

    - name: Terraform Init
      run: terraform init
      working-directory: lz-core

    - name: Check Env Variables (Apply Job)
      run: |
        echo "=== Apply Job ç¯å¢ƒå˜é‡æ£€æŸ¥ ==="
        echo "TFC_TOKEN: ${#TFC_TOKEN} characters"
        echo "ENV: $ENV"
        echo "TFC_ORG: $TFC_ORG"
        echo "WORKSPACE: $WORKSPACE"
        echo "Environment: ${{ github.event.inputs.environment || 'nonprod' }}"
        echo "TFC Organization: ${{ github.event.inputs.tfc_organization || 'HKJC-TFC-Nonprod1' }}"
        echo "TFC Workspace: ${{ github.event.inputs.tfc_workspace || 'HKJC-TFC-Nonprod1' }}"

    # ä¸‹è½½ plan æ–‡ä»¶
    - name: Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: tfplan-${{ github.event.inputs.environment || 'nonprod' }}
        path: lz-core/

    # æ‰§è¡Œ Apply
    - name: Terraform Apply
      env:
        TF_VAR_environment: ${{ github.event.inputs.environment || 'nonprod' }}
        TF_VAR_tfc_organization: $TFC_ORG
        TF_VAR_tfc_workspace: $WORKSPACE
      run: terraform apply -auto-approve -input=false tfplan
      working-directory: lz-core
